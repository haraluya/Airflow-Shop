# Airflow B2B 電商平台開發規範與指南

## 🎯 專案總覽與目標
Airflow 是專為電子煙批發產業設計的整合性B2B電商與CRM平台，採用現代化的全端Serverless架構。

**核心目標：**
- 建立統一的B2B批發下單與客戶關係管理系統
- 提供個人化的價格引擎與推薦碼分銷機制
- 實現後台訂單與Notion資料庫的雙向同步（過渡方案）
- 確保嚴格的資料隔離與多角色權限控制

## 🏗️ 開發階段規劃

### 第一階段：基礎架構與認證系統 (2-3週)
**目標**：建立專案骨架、Firebase設定、基礎認證功能

**主要任務：**
1. **專案初始化**
   - Next.js 14 (App Router) 專案建立
   - Firebase專案設定與服務啟用
   - TypeScript設定與基礎結構建立
   - Tailwind CSS + Radix UI 整合

2. **認證系統**
   - Firebase Authentication整合
   - 使用者角色權限基礎架構
   - 登入/註冊頁面實作
   - 基礎的路由保護

3. **資料模型設計**
   - Firestore資料庫結構建立
   - 基礎安全規則設定
   - 主要集合（users, products, orders等）架構

**驗收標準：**
- 使用者可以成功註冊並登入
- 基本的資料庫寫入讀取功能正常
- 專案可以正常build並部署

### 第二階段：客戶管理與CRM系統 (3-4週)
**目標**：完成客戶註冊審核、CRM功能、基礎後台管理

**主要任務：**
1. **客戶註冊與審核系統**
   - 客戶註冊表單與來源說明欄位
   - 管理員審核介面
   - 帳號狀態管理（待審核/已啟用/已拒絕）

2. **CRM功能**
   - 客戶詳情頁面
   - 標籤、來源、偏好品項管理
   - 多送貨地址功能
   - 客戶備忘錄系統

3. **基礎後台架構**
   - 後台儀表板佈局
   - 客戶列表與搜尋篩選
   - 基礎權限控制

**驗收標準：**
- 客戶可以提交註冊申請
- 管理員可以審核並管理客戶帳號
- CRM資料可以正常CRUD操作

### 第三階段：產品管理與價格引擎 (3-4週)
**目標**：商品管理系統、定價引擎、富文本編輯器

**主要任務：**
1. **產品管理系統**
   - 產品CRUD介面
   - 圖片上傳與管理
   - 產品分類與系列管理
   - 富文本編輯器(Tiptap)整合

2. **價格引擎核心**
   - 群組定價系統
   - 客戶專屬定價
   - 價格計算邏輯實作
   - 價格顯示權限控制

3. **商品前台展示**
   - 商品列表頁面
   - 商品詳情頁面
   - 價格顯示邏輯
   - 基礎搜尋功能

**驗收標準：**
- 管理員可以完整管理商品資料
- 價格引擎可以正確計算並顯示價格
- 前台商品展示功能完整

### 第四階段：購物流程與訂單系統 (3-4週)
**目標**：完整的B2B購物體驗、訂單管理

**主要任務：**
1. **購物車系統**
   - 購物車功能實作
   - 數量調整與商品管理
   - 購物車狀態持久化

2. **結帳流程**
   - 地址選擇與管理
   - 訂單確認頁面
   - 訂單提交處理

3. **訂單管理**
   - 訂單列表與詳情
   - 訂單狀態管理
   - 代客下單功能
   - 訂單搜尋與篩選

**驗收標準：**
- 客戶可以完成完整的購物流程
- 管理員可以處理並管理所有訂單
- 代客下單功能正常運作

### 第五階段：推薦碼分銷系統 (2-3週)
**目標**：業務員推薦碼、個人化內容、分銷追蹤

**主要任務：**
1. **推薦碼系統**
   - 推薦碼管理介面
   - URL路由與解析邏輯
   - 客戶綁定機制

2. **個人化內容**
   - 業務員資訊顯示
   - LINE聯絡資訊整合
   - 群組橫幅管理

3. **業務員門戶**
   - 業務員專屬後台
   - 績效儀表板
   - 客戶與訂單查詢

**驗收標準：**
- 推薦碼URL正確解析並綁定客戶
- 個人化內容正確顯示
- 業務員可以查看自己的績效資料

### 第六階段：Notion同步與最佳化 (2-3週)
**目標**：Notion雙向同步、效能最佳化、部署準備

**主要任務：**
1. **Notion同步模組**
   - Webhook接收處理
   - Cloud Tasks佇列實作
   - 雙向資料同步邏輯
   - 衝突解決機制

2. **系統最佳化**
   - 效能最佳化
   - 快取策略實作
   - 圖片最佳化
   - SEO最佳化

3. **部署與測試**
   - 生產環境部署
   - 完整功能測試
   - 效能測試

**驗收標準：**
- Notion同步功能完整運作
- 系統效能符合需求
- 生產環境成功部署

## 🎯 當前開發進度

### ✅ 第一階段：基礎架構與認證系統 (已完成 - 2024/09/02)

**已完成功能：**
1. **專案初始化**
   - ✅ Next.js 14 專案建立與配置
   - ✅ Firebase 服務整合與配置
   - ✅ TypeScript 嚴格模式設定
   - ✅ Tailwind CSS + Radix UI 整合
   - ✅ 專案目錄結構建立

2. **Firebase 整合**
   - ✅ Firebase Authentication 配置
   - ✅ Firestore 資料庫配置
   - ✅ Firebase Functions 準備
   - ✅ Firebase Storage 配置
   - ✅ 環境變數範例建立

3. **認證系統**
   - ✅ 使用者註冊功能（多步驟表單）
   - ✅ 使用者登入功能
   - ✅ 認證狀態管理 (AuthProvider)
   - ✅ 權限檢查 Hooks
   - ✅ 路由保護機制

4. **UI 元件系統**
   - ✅ Button 元件（多種變體）
   - ✅ Card 元件（含專用 ProductCard, OrderCard）
   - ✅ Input/Textarea/FormField 元件
   - ✅ 響應式設計與主題系統

5. **資料操作層**
   - ✅ 型別安全的 Firestore 服務類別
   - ✅ 使用者資料模型定義
   - ✅ 驗證 Schema (Zod)
   - ✅ 錯誤處理機制

6. **頁面與佈局**
   - ✅ 首頁 (行銷頁面)
   - ✅ 登入頁面
   - ✅ 註冊頁面
   - ✅ 根佈局與 SEO 設定

**技術驗證：**
- ✅ TypeScript 編譯無錯誤
- ✅ Next.js build 成功
- ✅ 開發伺服器正常啟動
- ✅ 專案結構符合最佳實踐

### ✅ 第二階段：客戶管理與CRM系統 (已完成 - 2025/01/11)

**已完成功能：**
1. **管理員後台系統**
   - ✅ 後台佈局與導航系統 (Sidebar + Header)
   - ✅ 響應式後台介面設計
   - ✅ 角色權限控制 (管理員/業務員分離)
   - ✅ 統一的搜尋與篩選界面

2. **客戶審核系統**
   - ✅ 客戶註冊審核頁面
   - ✅ 批准/拒絕客戶申請功能
   - ✅ 審核狀態管理 (待審核/已啟用/已停用)
   - ✅ 審核備註與拒絕原因紀錄
   - ✅ 實時更新與狀態同步

3. **客戶管理系統**
   - ✅ 客戶列表頁面與統計資料
   - ✅ 多條件搜尋與篩選功能
   - ✅ 客戶狀態統計卡片
   - ✅ 分頁與無限載入支援

4. **CRM客戶詳情**
   - ✅ 完整的客戶資料檢視頁面
   - ✅ 客戶基本資訊編輯功能
   - ✅ 商務設定 (信用額度、付款條件)
   - ✅ 管理員備註系統
   - ✅ 客戶狀態即時更新

5. **地址管理系統**
   - ✅ 多送貨地址管理元件
   - ✅ 地址新增、編輯、刪除功能
   - ✅ 預設地址設定
   - ✅ 表單驗證與錯誤處理

6. **標籤與備忘錄系統**
   - ✅ 客戶標籤管理 (顏色分類)
   - ✅ 多類型備忘錄系統 (通話、會議、郵件等)
   - ✅ 時間軸式備忘錄顯示
   - ✅ 標籤與備忘錄的CRUD功能

7. **Firebase服務整合**
   - ✅ 客戶資料服務 (CustomersService)
   - ✅ 基礎Firebase服務抽象層
   - ✅ Timestamp轉換處理
   - ✅ 資料驗證與型別安全

**技術成就：**
- ✅ 完整的後台權限控制系統
- ✅ 響應式設計支援所有裝置
- ✅ TypeScript 嚴格型別檢查通過
- ✅ 模組化元件架構
- ✅ 統一的錯誤處理機制
- ✅ 建置成功無編譯錯誤

### ✅ 第三階段：產品管理與價格引擎 (已完成 - 2025/09/02)

**已完成功能：**
1. **產品管理系統**
   - ✅ 產品CRUD介面完整實作
   - ✅ 圖片上傳與管理功能
   - ✅ 產品分類與品牌管理
   - ✅ 富文本編輯器(Tiptap)整合

2. **價格引擎核心**
   - ✅ 群組定價系統完整實作
   - ✅ 客戶專屬定價功能
   - ✅ 價格計算邏輯與引擎
   - ✅ 價格顯示權限控制

3. **商品前台展示**
   - ✅ 商品列表頁面 (Grid/List 視圖)
   - ✅ 商品詳情頁面完整功能
   - ✅ 個人化價格顯示邏輯
   - ✅ 商品搜尋與篩選功能

4. **搜尋與篩選系統**
   - ✅ 即時搜尋功能 (debounce 300ms)
   - ✅ 多條件篩選 (價格、分類、品牌、庫存)
   - ✅ 排序功能 (名稱、價格、時間、熱門)
   - ✅ 響應式篩選UI (桌面側邊欄 + 手機彈出式)
   - ✅ 分頁功能與無限載入支援

5. **Firebase服務完善**
   - ✅ 產品服務 (ProductsService) 完整CRUD
   - ✅ 分類服務 (CategoriesService) 階層管理
   - ✅ 品牌服務 (BrandsService) 完整管理
   - ✅ 價格引擎服務整合

6. **UI元件系統擴展**
   - ✅ 新增 Slider, ScrollArea, Separator, Label 元件
   - ✅ ProductFilters 篩選元件
   - ✅ AdvancedSearch 進階搜尋元件
   - ✅ 統一的錯誤處理與載入狀態

**技術成就：**
- ✅ 完整的B2B商品展示與搜尋體驗
- ✅ 個人化價格引擎整合
- ✅ 響應式設計支援所有裝置
- ✅ TypeScript 嚴格型別檢查通過
- ✅ 模組化架構與元件重用
- ✅ 客戶端性能優化 (搜尋防抖、分頁)

### ✅ 第四階段：購物流程與訂單系統 (已完成 - 2025/09/02)

**已完成功能：**
1. **購物車系統** ✅
   - ✅ 完整的購物車資料模型 (Cart, CartItem 介面)
   - ✅ Firebase 購物車服務 (CartService) 完整 CRUD
   - ✅ 購物車狀態管理 Hook (useCart)
   - ✅ 個人化價格整合與計算
   - ✅ 即時購物車同步機制
   - ✅ 購物車數量調整與商品管理
   - ✅ 購物車持久化儲存
   - ✅ 購物車頁面與UI元件

2. **結帳流程** ✅
   - ✅ 完整的結帳頁面 (/checkout)
   - ✅ 地址選擇與管理功能
   - ✅ 配送方式選擇 (標準配送、快速配送、門市自取)
   - ✅ 付款方式選擇 (銀行轉帳、貨到付款)
   - ✅ 訂單備註功能
   - ✅ 即時價格計算 (含運費、稅額)
   - ✅ 表單驗證與錯誤處理

3. **訂單系統** ✅
   - ✅ 完整的訂單資料模型 (Order, OrderItem 介面)
   - ✅ 訂單狀態管理 (待確認、已確認、處理中、已出貨、已送達、已取消)
   - ✅ 付款狀態管理 (待付款、已付款、逾期、已取消)
   - ✅ Firebase 訂單服務 (OrdersService) 完整 CRUD
   - ✅ 從購物車建立訂單功能
   - ✅ 自動訂單編號生成

4. **訂單管理頁面** ✅
   - ✅ 訂單列表頁面 (/orders) 
   - ✅ 訂單詳情頁面 (/orders/[id])
   - ✅ 訂單搜尋與篩選功能
   - ✅ 訂單狀態統計卡片
   - ✅ 響應式設計與載入狀態
   - ✅ 訂單成功頁面與導引

5. **UI 元件系統擴展** ✅
   - ✅ RadioGroup 元件 (地址選擇、付款方式選擇)
   - ✅ Label 元件更新
   - ✅ Badge 元件狀態顯示
   - ✅ 訂單狀態視覺化設計

6. **服務層架構** ✅
   - ✅ BaseFirebaseService 抽象類別
   - ✅ PricingService 價格計算引擎
   - ✅ OrdersService 訂單管理服務
   - ✅ 統一的錯誤處理與類型轉換
   - ✅ Timestamp 與 Date 轉換處理

**技術實現：**
- ✅ TypeScript 嚴格型別定義
- ✅ Firebase Firestore 即時資料同步
- ✅ 價格引擎整合 (個人化定價)
- ✅ React Hooks 狀態管理
- ✅ 錯誤處理與載入狀態
- ✅ 響應式UI設計
- ✅ 表單驗證與用戶體驗優化

**測試帳戶資訊：**
- **管理員帳戶**: admin@airflow-shop.com / admin123
- **客戶帳戶**: customer@test.com / test123
- **開發伺服器**: localhost:3003

**完整購物流程：**
1. ✅ 瀏覽商品 → 加入購物車
2. ✅ 查看購物車 → 調整數量
3. ✅ 前往結帳 → 選擇地址與付款方式
4. ✅ 確認訂單 → 提交下單
5. ✅ 查看訂單詳情 → 追蹤訂單狀態

**技術成就：**
- ✅ 完整的B2B購物與結帳系統
- ✅ 訂單全生命週期管理
- ✅ 個人化價格與定價引擎
- ✅ TypeScript 型別安全保證
- ✅ Firebase 服務層完整架構
- ✅ 測試環境與帳戶建立完成
- ✅ 響應式UI與用戶體驗優化

## 🔄 前後台分離架構修正計劃 (進行中)

### 📊 現況分析與問題
**發現問題：**
- 目前沒有真正的前後台分離設計
- 公開商場需要登入才能查看商品（不符合B2B展示需求）
- 後台管理沒有獨立入口（應為 `/admin`）
- 路由結構混合，缺乏明確的權限分層

**新架構需求：**
- **公開前台**：`domainname.com` - 可瀏覽商品與介紹，不顯示價格，不能購買
- **會員商城**：`domainname.com/shop` - 登入後可查看價格與執行購買
- **後台管理**：`domainname.com/admin` - 獨立的登入畫面與管理系統

### 🗓️ 修正計劃表

#### 🔄 第一階段：路由架構重構（1週）
**目標**：重新設計並實作新的路由架構

**新路由結構：**
```
├── / (公開首頁 - 行銷頁面)
├── /products (公開商品目錄 - 不顯示價格)
├── /products/[id] (公開商品詳情 - 不顯示價格)
├── /about (關於我們)
├── /contact (聯絡我們) 
├── /login (會員登入)
├── /register (會員註冊)
├── /shop (會員商城 - 需登入)
│   ├── /shop/products (會員商品頁 - 顯示價格)
│   ├── /shop/cart (購物車)
│   ├── /shop/checkout (結帳)
│   └── /shop/orders (訂單)
└── /admin (後台系統)
    ├── /admin (後台登入頁)
    ├── /admin/dashboard (後台儀表板)
    ├── /admin/customers (客戶管理)
    ├── /admin/products (商品管理)
    └── /admin/orders (訂單管理)
```

**主要任務：**
1. 重新組織 `app` 目錄結構
2. 建立 `(public)`, `(member)`, `(admin)` 路由群組
3. 更新路由常數與導航邏輯
4. 實作各層級的權限保護

#### 🔄 第二階段：公開前台實作（1週）
**目標**：建立不需認證的公開商城展示頁面

**主要任務：**
1. **公開商品目錄頁面** (`/products`)
   - 商品卡片不顯示價格
   - 顯示「會員限定價格」提示
   - 登入/註冊引導按鈕

2. **公開商品詳情頁面** (`/products/[id]`)
   - 完整的商品介紹與圖片
   - 隱藏價格與購買按鈕
   - 會員登入引導區域

3. **導航與佈局調整**
   - 公開頁面使用簡化導航
   - 會員功能引導設計

#### 🔄 第三階段：會員商城分離（1週）
**目標**：將現有購物功能遷移至會員專區

**主要任務：**
1. **會員專屬商城** (`/shop`)
   - 遷移現有的商品頁面至 `/shop/products`
   - 保留個人化價格顯示功能
   - 完整的購物車與結帳功能

2. **認證狀態處理**
   - 公開頁面 vs 會員頁面的狀態管理
   - 登入後的智能導向邏輯
   - 會員權限驗證中介軟體

#### 🔄 第四階段：後台系統獨立（1週）
**目標**：完全分離後台管理系統

**主要任務：**
1. **後台入口頁面** (`/admin`)
   - 獨立的後台登入介面
   - 管理員認證流程優化
   - 後台專屬的視覺設計

2. **後台路由保護**
   - 嚴格的管理員權限驗證
   - 後台 vs 前台的完全隔離
   - 管理員專屬的導航系統

### ✅ 預期成果
- 清晰的三層架構：公開展示 → 會員商城 → 管理後台
- 符合B2B商務邏輯的用戶體驗流程
- 嚴格的權限控制與資料隔離
- SEO友好的公開商品展示頁面

## 🔄 專案意識與上下文管理

### 必讀文件優先順序
1. **INITIAL.md** - 理解專案核心需求與架構
2. **商城規劃軟體需求規格生成.md** - 詳細功能規格
3. **當前開發階段任務** - 確認目前進度
4. **相關技術文件** - Firebase、Next.js、Notion API

### 上下文工程使用流程
1. **開始新對話時**：先閱讀INITIAL.md了解專案概況
2. **開始新功能時**：使用 `/generate-prp` 生成PRP文件
3. **實作功能時**：使用 `/execute-prp` 執行實作
4. **完成功能後**：更新進度並記錄到claude.md

## 🧱 程式碼結構與模組化原則

### 專案結構規範
```
airflow-shop/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/            # 認證相關頁面
│   │   ├── (dashboard)/       # 後台頁面
│   │   ├── (shop)/            # 前台商城頁面
│   │   └── api/               # API路由
│   ├── components/            # 共用元件
│   │   ├── ui/                # 基礎UI元件
│   │   ├── forms/             # 表單元件
│   │   └── layout/            # 版面元件
│   ├── lib/                   # 工具函式與設定
│   │   ├── firebase/          # Firebase設定
│   │   ├── utils/             # 通用工具
│   │   └── types/             # TypeScript型別定義
│   └── styles/                # 全域樣式
├── functions/                 # Firebase Functions
└── firestore.rules           # Firestore安全規則
```

### 檔案大小與模組化
- **檔案行數限制**：單一檔案不超過500行
- **元件單一職責**：每個元件只負責一個功能
- **型別定義分離**：統一管理在 `lib/types/` 目錄
- **API邏輯分離**：Firebase Functions獨立於前端邏輯

### Firebase架構規範
- **Authentication**：統一的認證狀態管理
- **Firestore**：嚴格的安全規則與資料結構
- **Functions**：API邏輯與伺服器端處理
- **Storage**：圖片與檔案儲存

## 🎨 UI/UX設計系統

### 色彩系統 (必須遵循)
- **主要漸層色**：orange (#FFA500) to blue (#0000FF)
- **背景色**：淺色模式白色，深色模式灰-900
- **文字色**：語意化命名，支援暗色模式
- **重點色**：成功綠、錯誤紅、警告黃

### 元件庫規範
- **基礎元件**：基於Radix UI，統一Tailwind CSS樣式
- **表單元件**：一致的驗證提示與錯誤處理
- **按鈕系統**：primary, secondary, ghost, destructive變體
- **響應式設計**：Mobile-First原則

### 字體排版
- **字體家族**：Inter或其他無襯線字體
- **排版尺度**：定義完整的標題與內文層次
- **行高與間距**：確保良好的閱讀體驗

## 🔒 安全性與權限控制

### 資料隔離原則
- **客戶資料隔離**：嚴格的Firestore安全規則
- **角色權限分離**：admin/customer/salesperson三層權限
- **API權限檢查**：所有API端點進行身份驗證
- **輸入驗證**：使用Zod進行嚴格的資料驗證

### 敏感資料處理
- **環境變數管理**：敏感設定不可寫死在程式碼中
- **API金鑰保護**：正確使用Firebase環境變數
- **使用者資料加密**：適當的資料傳輸與儲存加密

## 🧪 測試與品質保證

### 測試策略
- **單元測試**：關鍵業務邏輯必須有單元測試
- **整合測試**：API端點與資料庫操作測試
- **E2E測試**：主要使用者流程的端到端測試

### 程式碼品質
- **TypeScript嚴格模式**：啟用嚴格型別檢查
- **ESLint規則**：遵循Next.js推薦規則
- **Prettier格式化**：統一程式碼格式
- **Husky Git hooks**：提交前自動檢查

## 📚 文件與維護

### 文件標準
- **API文件**：所有API端點需有完整文件
- **元件文件**：共用元件需有使用範例
- **部署文件**：詳細的部署與環境設定說明

### 版本控制
- **Git flow**：使用功能分支開發模式
- **Commit訊息**：清楚的commit訊息格式
- **版本標籤**：每個里程碑建立版本標籤

## ⚠️ 常見陷阱與注意事項

### Firebase相關
- **冷啟動延遲**：Functions首次調用可能有延遲
- **並發限制**：注意Firestore的寫入速率限制
- **安全規則**：寫入規則前先在測試環境驗證

### Next.js相關
- **App Router**：確實理解新的路由系統
- **SSR vs CSR**：適當選擇渲染策略
- **圖片最佳化**：正確使用Next.js Image元件

### Notion API相關
- **速率限制**：每秒3次請求限制
- **佇列機制**：使用Cloud Tasks避免速率限制
- **錯誤處理**：完善的重試與錯誤恢復機制

## 🎯 AI助手行為規則

### 開發流程
- **始終先讀取INITIAL.md**：理解專案架構與需求
- **檢查當前開發階段**：確認目前進度與任務
- **使用PRP工作流程**：generate-prp → execute-prp
- **遵循程式碼規範**：不偏離既定的架構原則

### 實作原則  
- **不做假設**：不確定時主動詢問
- **不編造函式庫**：只使用已驗證的套件
- **確認路徑**：確保檔案路徑與模組名稱正確
- **保護現有程式碼**：除非明確指示，否則不刪除現有代碼

### Windows 11 開發環境適配
- **路徑格式**：使用正確的Windows路徑格式
- **PowerShell指令**：確保指令與Windows相容
- **換行符號**：注意Git的換行符號設定
- **Node.js版本**：確保使用相容的Node.js版本

## 📈 進度追蹤與里程碑

### 完成標準
每個開發階段都必須達成以下標準：
- ✅ 所有核心功能正常運作
- ✅ 單元測試涵蓋率達80%以上
- ✅ 無TypeScript錯誤或警告
- ✅ 通過ESLint檢查
- ✅ 可以成功部署到測試環境

### 文件更新
每完成一個階段後，必須更新：
- **README.md** - 功能清單與使用說明
- **CLAUDE.md** - 記錄完成的功能與下階段任務
- **API文件** - 新增的API端點文件
- **部署指南** - 環境變數與設定更新